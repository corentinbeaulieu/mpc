#%YAML 1.1
# Yaml version 1.1 is needed to avoid 'Map keys must be unique' error
# when parsing yaml file with yamllint.
# Gitlab yaml parser is broken and does not regognise the %YAML header...
# TODO: Uncomment previous header when gitlab has been fixed.
---
#Available stages to run in 'automatic' processing:
# For convenience, implicit stages have been made explicit here...
stages:
  - Installations
  - Regular Testing
  - Applications
  - Benchmarks
  - Extended Network Testing
  - Extended Threads Testing
  - Extra Steps
  - Configurations
  - Additional Testing
  - Release

# Add clone variables for concurrent PIPELINES
variables:
  GL_PIPELINE_PATH: $CI_BUILDS_DIR/GL_$CI_PIPELINE_ID
  GL_BUILD_DIR: $GL_PIPELINE_PATH/build
  GL_INSTALL_DIR: $GL_PIPELINE_PATH/install
  GL_INSTALL_COMMON_OPTS: --enable-debug --with-pmix -j32
  GIT_DEPTH: 1 # No need to clone the whole history
  #GIT_CLONE_PATH: $GL_PIPELINE_PATH/$CI_RUNNER_ID/$CI_CONCURRENT_ID
  PCVS_RUN: pcvs -v run --override --profile-path ${GL_PIPELINE_PATH}/mpc_ci/utils/profile/mpc.yml
  PCVS_COMMAND: ${PCVS_RUN} --print errors -S
  PCVS_COMMAND_BENCH: ${PCVS_RUN} --print all -S

.pcvs_prepare: &pcvs_prepare
  - export CI_PCVS_DIR="$GL_PIPELINE_PATH/step_$(echo "$CI_JOB_NAME" | sed -e "s/ /_/g")/"
  - test -d "${CI_PCVS_DIR}" && rm -rf "${CI_PCVS_DIR}"
  - mkdir -p "${CI_PCVS_DIR}"
  - cd "${GL_PIPELINE_PATH}"
  - test "x${CI_BRANCH}" != "x" && echo "Using CI branch ${CI_BRANCH}"
  - mkdir mpc_ci 2>"/dev/null"
      && git clone "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ccc.ocre.cea.fr/cea-mpc-team/mpc-ci.git" $(test "x${CI_BRANCH}" != "x" && echo "-b ${CI_BRANCH}") "mpc_ci"
      || sleep 5s
  - cd "${CI_PCVS_DIR}"
  - echo "Step run from ${CI_PCVS_DIR}"
  - source ${GL_LOCAL_INSTALL_DIR}/mpcvars.sh
  - echo "MPC loaded from ${GL_LOCAL_INSTALL_DIR}/mpcvars.sh"
  - source "$(ccc_home -u mpc)"/gitlab-runner/spack_organizer_inti/setup.sh
  - spack env activate mpc-runner-deps
  - module load pmix gnu/13.3.0

# Pipeline launching rules
workflow:
  rules:
    # If pipeline is disabled => don't do
    - if: '$CI_MERGE_REQUEST_LABELS =~ /CI::Disabled/'
      when: never
    # If it is a merge request => do
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # If it is triggered on the web page => do
    - if: '$CI_PIPELINE_SOURCE == "web"'
    # If it is a scheduled pipepine => do
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    # If it is a release
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_BRANCH == "master"'

.slurm_tag:
  tags:
    - slurm


############################
##### EXTRA ACTIONS ########
############################
#these actions should herit from implicit stages ".pre" and ".post"

# pre-actions to cleanup the machine before the run
# this job will be run in ANY pipeline -> ensure to enable all proper tags
# CAUTION : Otherwise tag-specific runners won't allow to run the whole pipeline because
# both .pre and .post cannot be scheduled (thus, why not using user-defined pre and post
# to avoid them to be run systematically ?)
Env Sanitize:
  stage: .pre
  needs: []
  script:
    - test -d $GL_PIPELINE_PATH && rm -rf $GL_PIPELINE_PATH
    - mkdir -p $GL_PIPELINE_PATH
    - ln -snf "$(ccc_home -u mpc)"/mpc_deps "${HOME}"/.mpcdep

Resource Relinquishing:
  stage: .post
  when: always
  script:
    - echo "Suppressing ${GL_PIPELINE_PATH} data"
  after_script:
    - rm -rf ${GL_INSTALL_DIR} ${GL_BUILD_DIR}
    - rm -rf ${GL_PIPELINE_PATH}/*

############################
####### CONF STAGE  ########
############################

.conf_run_cmds: &configuration_commands
  - echo "${GL_BUILD_DIR}"
  - echo "${GL_INSTALL_DIR}"
  - rm -rf ${GL_LOCAL_BUILD_DIR} ${GL_LOCAL_INSTALL_DIR}
  - mkdir ${GL_LOCAL_BUILD_DIR}; cd ${GL_LOCAL_BUILD_DIR}
  - module load pmix gnu/13.3.0
  - ${CI_PROJECT_DIR}/installmpc -vv --prefix=${GL_LOCAL_INSTALL_DIR} ${GL_INSTALL_OPTS}

# Default configuration need pmix to work on inti.
Process Mode Installation:
  stage: Installations
  needs:
    - [Env Sanitize]
  variables:
    GL_LOCAL_BUILD_DIR: ${GL_BUILD_DIR}_process_mode
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
    GL_INSTALL_OPTS: ${GL_INSTALL_COMMON_OPTS} --disable-mpc-autopriv --disable-spack
  script:
    - *configuration_commands

Privatization Installation:
  stage: Installations
  needs:
    - [Env Sanitize]
  variables:
    GL_LOCAL_BUILD_DIR: ${GL_BUILD_DIR}_privatization
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
    GL_INSTALL_OPTS: ${GL_INSTALL_COMMON_OPTS}
  script:
    - *configuration_commands

############################
####### TEST STAGE ########
############################

#
# Basic Testing
# to stop the pipeline early in case of major issue
# (not able to compile/run a simple test)
#

Process Mode Simple Run:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Process Mode Installation]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/trivial/"

Privatization Simple Run:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Privatization Installation]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/trivial/"

Privatization:
  extends: ['.slurm_tag']
  stage: Additional Testing
  needs: [Privatization Installation]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/privatization/"

Process Mode Reproducers:
  extends: ['.slurm_tag']
  stage: Additional Testing
  needs: [Process Mode Installation]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
    REPRODUCERS_PATH: ${GL_PIPELINE_PATH}/mpc_ci/reproducers
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${REPRODUCERS_PATH}/basics" "${REPRODUCERS_PATH}/lowcomm" "${REPRODUCERS_PATH}/MPI"

Privatization Reproducers:
  extends: ['.slurm_tag']
  stage: Additional Testing
  needs: [Privatization Installation]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
    REPRODUCERS_PATH: ${GL_PIPELINE_PATH}/mpc_ci/reproducers
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${REPRODUCERS_PATH}"

#
# Regular Testing
# to assess some basic MPC feature
#

Process Mode Lowcomm:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Process Mode Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/lowcomm/"

Process Mode MPI Simple C:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Process Mode Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/simple/c/"

Process Mode MPI Simple Fortran:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Process Mode Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/simple/fortran/"

Process Mode OpenMP Tasking examples:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Process Mode Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/OpenMP/task/examples"

Process Mode OpenMP Tasking cholesky:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Process Mode Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - module load llvm
    - module load lapack/mkl
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/OpenMP/task/cholesky"

Privatization Lowcomm:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Privatization Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/lowcomm/"

Privatization MPI Simple C:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Privatization Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/simple/c/"

Privatization MPI Simple Fortran:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Privatization Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/simple/fortran/"

Privatization OpenMP Tasking examples:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Privatization Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/OpenMP/task/examples"

Privatization OpenMP Tasking cholesky:
  extends: ['.slurm_tag']
  stage: Regular Testing
  needs:
    - [Privatization Simple Run]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - module load llvm
    - module load lapack/mkl
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/OpenMP/task/cholesky"

#
# Benchmarks & Applications
#

Process Mode MPI IMB-MPI 2017:
  extends: ['.slurm_tag']
  stage: Benchmarks
  needs:
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/IMB_2017/check-mpi/"

Process Mode MPI IMB-NBC 2017:
  extends: ['.slurm_tag']
  stage: Benchmarks
  needs:
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/IMB_2017/check-nbc/"

Process Mode MPI NBC:
  extends: ['.slurm_tag']
  stage: Benchmarks
  needs:
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/NBC/"

Process Mode NAS-MZ MPI:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/hybrid/NAS/MZ-MPI/"

Process Mode Lulesh:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
    - [Process Mode OpenMP Tasking cholesky, Process Mode OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/corals/lulesh-2.0.3/"

Process Mode miniFe:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
    - [Process Mode OpenMP Tasking cholesky, Process Mode OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/corals/miniFe/"

Process Mode OMP NAS-MZ:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Process Mode OpenMP Tasking cholesky, Process Mode OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/hybrid/NAS/MZ-OMP/"


Privatization MPI IMB-MPI 2017:
  extends: ['.slurm_tag']
  stage: Benchmarks
  needs:
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/IMB_2017/check-mpi/"

Privatization MPI IMB-NBC 2017:
  extends: ['.slurm_tag']
  stage: Benchmarks
  needs:
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/IMB_2017/check-nbc/"

Privatization MPI NBC:
  extends: ['.slurm_tag']
  stage: Benchmarks
  needs:
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/MPI/NBC/"

Privatization MPI NAS-MZ:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/hybrid/NAS/MZ-MPI/"

Privatization Lulesh:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
    - [Privatization OpenMP Tasking cholesky, Privatization OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/corals/lulesh-2.0.3/"

Privatization miniFe:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
    - [Privatization OpenMP Tasking cholesky, Privatization OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/corals/miniFe/"

Privatization OMP NAS-MZ:
  extends: ['.slurm_tag']
  stage: Applications
  needs:
    - [Privatization OpenMP Tasking cholesky, Privatization OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization
  script:
    - *pcvs_prepare
    - ${PCVS_COMMAND} "${GL_PIPELINE_PATH}/mpc_ci/hybrid/NAS/MZ-OMP/"


# Configurations
Configurations:
  stage: Configurations
  needs: [Env Sanitize]
  parallel:
    matrix:
      - CONFIGURATION_NAME: DisableLowcomm
        GL_INSTALL_OPTS: ${GL_INSTALL_COMMON_OPTS} --disable-mpc-autopriv --mpc-option="--disable-lowcomm"
      - CONFIGURATION_NAME: DisableMPI
        GL_INSTALL_OPTS: ${GL_INSTALL_COMMON_OPTS} --disable-mpc-autopriv --mpc-option="--disable-mpi"
      - CONFIGURATION_NAME: DisableThreads
        GL_INSTALL_OPTS: ${GL_INSTALL_COMMON_OPTS} --disable-mpc-autopriv --mpc-option="--disable-threads"
      - CONFIGURATION_NAME: DisablePMIx
        GL_INSTALL_OPTS: --disable-mpc-autopriv --enable-debug -j32
      - CONFIGURATION_NAME: DisableMPCAlloc
        GL_INSTALL_OPTS: ${GL_INSTALL_COMMON_OPTS} --disable-mpcalloc
  variables:
    GL_LOCAL_BUILD_DIR: ${GL_BUILD_DIR}_${CONFIGURATION_NAME}
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_${CONFIGURATION_NAME}
  script:
    - *configuration_commands
  after_script:
    - rm -rf ${GL_LOCAL_INSTALL_DIR} ${GL_LOCAL_BUILD_DIR}

# FIXME: We have to update Workshare for this test to pass
# MPC Compilation Workshare:
#   stage: Configurations
#   variables:
#     GL_LOCAL_BUILD_DIR: ${GL_BUILD_DIR}_workshare
#     GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_workshare
#     GL_INSTALL_OPTS: --enable-workshare --enable-debug
#   allow_failure: true
#   script:
#     - *configuration_commands

############################################
####### Pre-commit and documentation #######
############################################

Check Precommit Rules:
  stage: Extra Steps
  needs: [Env Sanitize]
  before_script:
    - source "$(ccc_home -u mpc)"/gitlab-runner/spack_organizer_inti/setup.sh
    - spack env activate mpc-runner-deps
    - export PATH=$PATH:"$(ccc_home -u mpc)/mpc_pre_commit/bin"
  script:
    - cd ${CI_PROJECT_DIR}
    - intify_pre_commit.sh .pre-commit-config.yaml
    - git add .pre-commit-config.yaml
    - spack load py-ruamel-yaml
    - git config --global --add safe.directory "$(ccc_home -u mpc)/mpc_pre_commit/pre_commit_hooks/pre-commit-hooks/.git"
    - git config --global --add safe.directory "$(ccc_home -u mpc)/mpc_pre_commit/pre_commit_hooks/pocc/.git"
    - pre-commit install --install-hooks
    # FIXME: Do not run the clang-tidy hook as it needs a compile_commands.json
    - pre-commit run --all-files --hook-stage manual


##############################
####### EXTENDED TESTS #######
##############################
.extended_tests:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - if: '$CI_MERGE_REQUEST_LABELS =~ /CI::Extended/'
      when: always
    - if: '$EXTENDED'
      when: always

Retrieve Benchmarks:
  stage: .pre
  needs: [Env Sanitize]
  extends: ['.extended_tests']
  variables:
    EXTENDED_TESTS_PATH: "${GL_PIPELINE_PATH}/pcvs-benchmarks"
  script:
    - test "x${BENCHMARKS_BRANCH}" != "x" || BENCHMARKS_BRANCH=devel
    - echo "${BENCHMARKS_BRANCH}"
    - |
      if [ ! -d ${EXTENDED_TESTS_PATH} ]; then
        git clone --branch "${BENCHMARKS_BRANCH}" --depth 1 "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ccc.ocre.cea.fr/cea-mpc-team/pcvs-benchmarks.git" "${EXTENDED_TESTS_PATH}"
      fi


.pcvs_benchmarks:
  extends: ['.slurm_tag', '.extended_tests']
  variables:
    EXTENDED_TESTS_PATH: "${GL_PIPELINE_PATH}/pcvs-benchmarks"
  before_script:
    - *pcvs_prepare

.process_mode_pcvs_benchmarks:
  extends: ['.pcvs_benchmarks']
  needs:
    - [Retrieve Benchmarks]
    - [Process Mode Lowcomm, Process Mode MPI Simple C, Process Mode MPI Simple Fortran]
    - [Process Mode OpenMP Tasking cholesky, Process Mode OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_process_mode

.privatization_pcvs_benchmarks:
  extends: ['.pcvs_benchmarks']
  needs:
    - [Retrieve Benchmarks]
    - [Privatization Lowcomm, Privatization MPI Simple C, Privatization MPI Simple Fortran]
    - [Privatization OpenMP Tasking cholesky, Privatization OpenMP Tasking examples]
  variables:
    GL_LOCAL_INSTALL_DIR: ${GL_INSTALL_DIR}_privatization


## Benchmarks

### MPI

Process Mode Intel ANL:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script: ['${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/Intel_ANL"']

Process Mode MPI-IO:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/HACC"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/HPIO"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/PIO"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/ROMIO"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/ROMPIO"

Process Mode NAS:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/NAS"

Process Mode PARCO Thread Tests:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/Threading"

Process Mode MPICH 3.4.2:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/mpich-3.4.2"

Process Mode RMA MT:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND_BENCH} "${EXTENDED_TESTS_PATH}/MPI/rma-mt"

### OMP

Process Mode OMP BOTS:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/BOTS"

Process Mode CLOMP:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/CLOMP"

Process Mode EPCC:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/EPCC"

Process Mode GOMP:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/GOMP"

Process Mode NAS OMP:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/NAS"

Process Mode OpenUH:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/OpenUH/c"\
                      "${EXTENDED_TESTS_PATH}/OpenMP/OpenUH/fortran"

Process Mode simple:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/simple"

### Threads

Process Mode Threads:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/Threads/cpp"\
                      "${EXTENDED_TESTS_PATH}/Threads/futex"\
                      "${EXTENDED_TESTS_PATH}/Threads/interfaces"\
                      "${EXTENDED_TESTS_PATH}/Threads/tbb"

### Performance

Process Mode OSU:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND_BENCH} "${EXTENDED_TESTS_PATH}/performance/OSU"

## Applications

Process Mode Corals:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Benchmarks'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/applications/Corals/AMG2013"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/UMT2013"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/graph500-2.1.4"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/mcb-20130723"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/neckbone-2.3.4"

Process Mode Mantevo:
  extends: ['.process_mode_pcvs_benchmarks']
  stage: 'Applications'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/applications/Mantevo/CloverLeaf-master"\
                      "${EXTENDED_TESTS_PATH}/applications/Mantevo/HPCCG-master"\
                      "${EXTENDED_TESTS_PATH}/applications/Mantevo/miniAMR-master"\
                      "${EXTENDED_TESTS_PATH}/applications/Mantevo/miniGhost-1.0.1"


## Benchmarks

### MPI

Privatization Intel ANL:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script: ['${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/Intel_ANL"']

Privatization MPI-IO:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/HACC"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/HPIO"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/PIO"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/ROMIO"\
                      "${EXTENDED_TESTS_PATH}/MPI/MPI-IO/ROMPIO"

Privatization NAS:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/NAS"

Privatization PARCO Thread Tests:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/Threading"

Privatization MPICH 3.4.2:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/mpich-3.4.2"

Privatization RMA MT:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND_BENCH} "${EXTENDED_TESTS_PATH}/MPI/rma-mt"

### OMP

Privatization OMP BOTS:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/BOTS"

Privatization CLOMP:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/CLOMP"

Privatization EPCC:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/EPCC"

Privatization GOMP:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/GOMP"

Privatization NAS OMP:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/NAS"

Privatization OpenUH:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/OpenUH/c"\
                      "${EXTENDED_TESTS_PATH}/OpenMP/OpenUH/fortran"

Privatization simple:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/OpenMP/simple"

### Threads

Privatization Threads:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Threads Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/Threads/cpp"\
                      "${EXTENDED_TESTS_PATH}/Threads/futex"\
                      "${EXTENDED_TESTS_PATH}/Threads/interfaces"\
                      "${EXTENDED_TESTS_PATH}/Threads/tbb"

Privatization Thread based:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Additional Testing'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/MPI/Thread_based/hls/c++"\
                      "${EXTENDED_TESTS_PATH}/MPI/Thread_based/hls/c"\
                      "${EXTENDED_TESTS_PATH}/MPI/Thread_based/hls/fortran"\
                      "${EXTENDED_TESTS_PATH}/MPI/Thread_based/privatization/c++"\
                      "${EXTENDED_TESTS_PATH}/MPI/Thread_based/privatization/c"\
                      "${EXTENDED_TESTS_PATH}/MPI/Thread_based/privatization/fortran"


### Performance

Privatization OSU:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Extended Network Testing'
  script:
    - ${PCVS_COMMAND_BENCH} "${EXTENDED_TESTS_PATH}/performance/OSU"

## Applications

Privatization Corals:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Benchmarks'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/applications/Corals/AMG2013"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/UMT2013"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/graph500-2.1.4"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/mcb-20130723"\
                      "${EXTENDED_TESTS_PATH}/applications/Corals/neckbone-2.3.4"

Privatization Mantevo:
  extends: ['.privatization_pcvs_benchmarks']
  stage: 'Applications'
  script:
    - |
      ${PCVS_COMMAND} "${EXTENDED_TESTS_PATH}/applications/Mantevo/CloverLeaf-master"\
                      "${EXTENDED_TESTS_PATH}/applications/Mantevo/HPCCG-master"\
                      "${EXTENDED_TESTS_PATH}/applications/Mantevo/miniAMR-master"\
                      "${EXTENDED_TESTS_PATH}/applications/Mantevo/miniGhost-1.0.1"

###################################
####### MANUALLY TRIGGERED ########
###################################
#This section gathers jobs not scheduled to be part of the standard pipeline.
#They could be run manually or periodically.

#When triggered through a variable, MPC is built in containers with fixed software stack (base compiler, libc, etc...)
# to ensure MPC to compile in a large variety of environments

Debian Stretch:
  stage: Additional Testing
  script: "docker run --rm -it paratoolsfrance/mpc-env:debian-stretch $HOME/docker/run_installmpc.sh"
  tags:
    - "docker"
  only:
    variables:
      - $MPC_CI_MODE == "multibuild"

Centos 7:
  stage: Additional Testing
  script: "docker run --rm -it paratoolsfrance/mpc-env:centos-7 $HOME/docker/run_installmpc.sh"
  tags:
    - "docker"
  only:
    variables:
      - $MPC_CI_MODE == "multibuild"

# FIXME:
# 1.Needs docker
# 2. The scripts are broken
#
# release:
#   stage: Release
#   rules:
#     - if: $CI_COMMIT_TAG && $CI_COMMIT_BRANCH == "master"
#   script: utils/release_all.sh $(ccc_home -u mpc_nr)/releases/$CI_COMMIT_TAG
#   release:
#     tag_name: '$CI_COMMIT_TAG'
#     description: '$CI_COMMIT_TAG_MESSAGE'
#   artifacts:
#     paths: [$(ccc_home -u mpc_nr)/releases/$CI_COMMIT_TAG]
